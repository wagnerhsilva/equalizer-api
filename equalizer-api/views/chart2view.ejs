<!DOCTYPE html>
<html lang="en-us" ng-app="app">

<head>
    <% include partials/head %>
</head>

<body class="">
    <% include partials/header %>
        <div id="main" role="main">

            <!-- RIBBON -->
            <div id="ribbon">

                <!-- breadcrumb -->
                <ol class="breadcrumb">
                    <li>Status</li>
                    <li>Gráfico</li>
                </ol>
            </div>
            <div id="content">
                <div class="row">
                    <article class="col-sm-12 col-md-12 col-lg-12">
                        <div>

                            <div class="jarviswidget-editbox">
                            </div>
                            <div class="widget-body">
                                <ng-view></ng-view>
                            </div>
                        </div>
                    </article>
                </div>
                <script type="text/ng-template" id="/chart2.html">
                    <button type="submit" class="btn btn-primary pull-right" style="margin-left:5px;" ng-click="chart(3)">Tensão</button>
                    <button type="submit" class="btn btn-primary pull-right" style="margin-left:5px;" ng-click="chart(2)">Temperatura</button>
                    <button type="submit" class="btn btn-primary pull-right" ng-click="chart(1)">Impedância</button>
                    <header>
                        <h3 id="headerVisao">Impedância</h3>

                    </header>
                    <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false" ng-repeat="string in stringsDistintas2">
                        <header>
                            <span class="widget-icon"> <i class="fa fa-bar-chart-o"></i> </span>
                            <h2 id="headerGrafico_{{string}}"></h2>

                        </header>

                        <!-- widget div-->
                        <div>

                            <!-- widget edit box -->
                            <div class="jarviswidget-editbox">
                                <!-- This area used as dropdown edit box -->

                            </div>
                            <!-- end widget edit box -->

                            <!-- widget content -->
                            <div class="widget-body no-padding">

                                <div id="bar-chart_{{string}}" style="height:500px;" class="chart"></div>

                            </div>
                            <!-- end widget content -->

                        </div>
                        <!-- end widget div -->

                    </div>
                </script>
                <script>
                    angular.module('app', ['ngRoute', 'ngResource'])
                        //---------------
                        // Services
                        //---------------
                        .factory('StatusModulos', ['$resource', function ($resource) {
                            return $resource('/statusmodulo/:id', null, {
                                'update': { method: 'PUT' },
                                'query': {
                                    isArray: true,
                                    method: 'GET'
                                }
                            });
                        }])
                        //---------------
                        // Controllers
                        //---------------
                        .controller('Chart2Controller', ['$scope', 'StatusModulos', function ($scope, StatusModulos) {
                            $scope.charts = StatusModulos.query(function (res) {
                                var flags = [], output = [], output2 = [], l = res.length, i;
                                for (i = 0; i < l; i++) {
                                    if (flags[res[i].string]) continue;
                                    flags[res[i].string] = true;
                                    output.push(res[i].string);
                                    output2.push(res[i].string.replace(" ", "_"));
                                }
                                $scope.stringsDistintas = output;
                                $scope.stringsDistintas2 = output2;
                                setTimeout(function () { chart(res, 1, output); }, 500);
                            }, function (error) {

                            });
                            $scope.chart = function (index) {
                                $scope.index = index;
                                chart($scope.charts, index == undefined ? 1 : index, $scope.stringsDistintas);
                            }
                        }])
                        //---------------
                        // Routes
                        //---------------
                        .config(['$routeProvider', function ($routeProvider) {
                            $routeProvider
                                .when('/', {
                                    templateUrl: '/chart2.html',
                                    controller: 'Chart2Controller'
                                })
                        }]);
                </script>

            </div>
            <!-- END MAIN CONTENT -->

        </div>
        <script type="text/javascript">
            /* chart colors default */
            var $chrt_border_color = "#efefef";
            var $chrt_grid_color = "#DDD"
            var $chrt_main = "#E24913";
            /* red       */
            var $chrt_second = "#6595b4";
            /* blue      */
            var $chrt_third = "#FF9F01";
            /* orange    */
            var $chrt_fourth = "#7e9d3a";
            /* green     */
            var $chrt_fifth = "#BD362F";
            /* dark red  */
            var $chrt_mono = "#000";
            function chart(data, index, strings) {
                var visao = index;
                if (visao == 1) {
                    $("#headerVisao").text("Impedância");
                    strings.forEach(function (string) {
                        if ($("#bar-chart_" + string.replace(" ", "_")).length) {
                            $("#headerGrafico_" + string.replace(" ", "_")).text("String: " + string);
                            var data1 = [];
                            var labels1 = [];
                            var conta = 0;
                            data.forEach(function (element) {
                                if (element.string == string) {
                                    if (element.impedancia > element.max_imp) {
                                        data1.push({ data: [[conta, parseFloat(element.impedancia)]], color: "red", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    } else if (element.impedancia < element.min_imp) {
                                        data1.push({ data: [[conta, parseFloat(element.impedancia)]], color: "yellow", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    } else {
                                        data1.push({ data: [[conta, parseFloat(element.impedancia)]], color: "green", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    }
                                    labels1.push([conta, element.bateria]);
                                    conta++;
                                }
                            }, this);
                            var options = {
                                xaxis: { ticks: labels1 },
                                grid: {
                                    show: true,
                                    hoverable: true,
                                    clickable: true,
                                    tickColor: $chrt_border_color,
                                    borderWidth: 0,
                                    borderColor: $chrt_border_color,
                                },
                                legend: true,
                                tooltip: true,
                                tooltipOpts: {
                                    content: "<b>Impedância</b> = <span>%y.1</span>",
                                    defaultTheme: false
                                }
                            };
                            $.plot($("#bar-chart_" + string.replace(" ", "_")), data1, options);
                        }
                    }, this);

                }
                else if (visao == 2) {
                    $("#headerVisao").text("Temperatura");
                    strings.forEach(function (string) {
                        if ($("#bar-chart_" + string.replace(" ", "_")).length) {
                            $("#headerGrafico_" + string.replace(" ", "_")).text("String: " + string);
                            var data1 = [];
                            var labels1 = [];
                            var conta = 0;
                            data.forEach(function (element) {
                                if (element.string == string) {
                                    if (element.temperatura > element.max_temp) {
                                        data1.push({ data: [[conta, parseFloat(element.temperatura)]], color: "red", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    } else if (element.temperatura < element.min_temp) {
                                        data1.push({ data: [[conta, parseFloat(element.temperatura)]], color: "yellow", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    } else {
                                        data1.push({ data: [[conta, parseFloat(element.temperatura)]], color: "green", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    }
                                    labels1.push([conta, element.bateria]);
                                    conta++;
                                }
                            }, this);
                            var options = {
                                xaxis: { ticks: labels1 },
                                grid: {
                                    show: true,
                                    hoverable: true,
                                    clickable: true,
                                    tickColor: $chrt_border_color,
                                    borderWidth: 0,
                                    borderColor: $chrt_border_color,
                                },
                                legend: true,
                                tooltip: true,
                                tooltipOpts: {
                                    content: "<b>Temperatura</b> = <span>%y.1</span>",
                                    defaultTheme: false
                                }
                            };
                            $.plot($("#bar-chart_" + string.replace(" ", "_")), data1, options);
                        }
                    }, this);
                } else if (visao == 3) {
                    $("#headerVisao").text("Tensão");
                    strings.forEach(function (string) {
                        if ($("#bar-chart_" + string.replace(" ", "_")).length) {
                            $("#headerGrafico_" + string.replace(" ", "_")).text("String: " + string);
                            var data1 = [];
                            var labels1 = [];
                            var conta = 0;
                            data.forEach(function (element) {
                                if (element.string == string) {
                                    if (element.tensao > element.max_tensao) {
                                        data1.push({ data: [[conta, parseFloat(element.tensao)]], color: "red", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    } else if (element.tensao < element.min_tensao) {
                                        data1.push({ data: [[conta, parseFloat(element.tensao)]], color: "yellow", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    } else {
                                        data1.push({ data: [[conta, parseFloat(element.tensao)]], color: "green", label: 'Impedância', bars: { show: true, align: 'center', barWidth: 0.5 } });
                                    }
                                    labels1.push([conta, element.bateria]);
                                    conta++;
                                }
                            }, this);
                            var options = {
                                xaxis: { ticks: labels1 },
                                grid: {
                                    show: true,
                                    hoverable: true,
                                    clickable: true,
                                    tickColor: $chrt_border_color,
                                    borderWidth: 0,
                                    borderColor: $chrt_border_color,
                                },
                                legend: true,
                                tooltip: true,
                                tooltipOpts: {
                                    content: "<b>Tensão</b> = <span>%y.3</span>",
                                    defaultTheme: false
                                }
                            };
                            $.plot($("#bar-chart_" + string.replace(" ", "_")), data1, options);
                        }
                    }, this);
                }
            }
        </script>
        <% include partials/footer %>
</body>

</html>